import React, { useState } from "react";
import {
  Card,
  CardContent,
  CardActions,
  Typography,
  Collapse,
  IconButton,
  Box,
  Divider,
  Grid,
  Chip,
} from "@mui/material";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import InsightsIcon from "@mui/icons-material/Insights";
import { useSpring, animated } from "react-spring";
import { NumericFormat } from "react-number-format";
import MonetizationOnIcon from "@mui/icons-material/MonetizationOn";

// Helper function to get severity color based on numeric value
const getSeverityColor = (severity) => {
  if (severity >= 8) return "#d32f2f"; // Red for Critical (Severity >= 8)
  if (severity >= 5) return "#f57c00"; // Orange for High (Severity >= 5)
  if (severity >= 3) return "#fbc02d"; // Yellow for Medium (Severity >= 3)
  return "#388e3c"; // Green for Low (Severity < 3)
};

const VulnerabilityCard = ({ vuln, data }) => {
  const [expanded, setExpanded] = useState(false);
  const toggleExpand = () => setExpanded(!expanded);

  const severityColor = getSeverityColor(vuln.Severity); // Get the severity color

  // Spring animation for expand/collapse effect
  const animationProps = useSpring({
    opacity: expanded ? 1 : 0,
    transform: expanded ? "translateY(0)" : "translateY(-10px)",
    scale: expanded ? 1 : 1.05, // Adds a slight zoom in effect when the card is expanded
    boxShadow: expanded
      ? "0px 4px 20px rgba(0, 0, 0, 0.2)"
      : "0px 2px 10px rgba(0, 0, 0, 0.1)", // Adds shadow when expanded for a "highlighted" effect
  });

  // Hover animation for the Insights Icon button
  const hoverProps = useSpring({
    transform: expanded ? "rotate(0deg)" : "rotate(180deg)", // Icon rotates when expanded
    scale: expanded ? 1 : 1.2, // Slight scale change on hover
  });

  return (
    <Card variant="outlined" sx={{ margin: "16px 0" }}>
      <CardContent
        sx={{ display: "flex", flexDirection: "row", alignItems: "center" }}
      >
        <Box sx={{ flexGrow: 1 }}>
          <Typography variant="h6">{vuln.CVE}</Typography>
          <Typography>
            <strong>Port:</strong> {vuln.Port}
          </Typography>
          <Typography>
            <strong>Protocol:</strong> {vuln.Protocol}
          </Typography>
        </Box>

        <Box
          sx={{
            display: "inline-block",
            padding: "4px 12px",
            borderRadius: "20px",
            backgroundColor: severityColor,
            color: "white",
            fontWeight: "bold",
            marginLeft: "auto",
            textAlign: "center",
          }}
        >
          {vuln.Severity}
        </Box>
      </CardContent>

      <CardActions>
        <IconButton
          onClick={toggleExpand}
          sx={{ transition: "transform 0.3s", marginLeft: "auto" }}
        >
          <animated.div style={hoverProps}>
            <InsightsIcon />
          </animated.div>
        </IconButton>
      </CardActions>

      <Collapse in={expanded} timeout="auto" unmountOnExit>
        <animated.div style={animationProps}>
          <CardContent>
            {/* Cost Breakdown Section with Enhanced UI */}
            <Box
              sx={{ display: "flex", flexDirection: "column", marginBottom: 2 }}
            >
              <Typography variant="h6" sx={{ marginBottom: 2 }}>
                Cost Breakdown
              </Typography>

              {/* Grid Layout for Side-by-Side Cost Display */}
              <Grid container spacing={4}>
                {/* Fix Cost Section */}
                <Grid
                  item
                  xs={12}
                  sm={6}
                  sx={{ display: "flex", justifyContent: "center" }}
                >
                  <Box sx={{ textAlign: "center" }}>
                    <MonetizationOnIcon
                      sx={{
                        fontSize: 60,
                        color: "#388e3c", // Green color for the icon (you can customize)
                      }}
                    />
                    <Typography variant="h6" sx={{ marginTop: 1 }}>
                      <strong>Fix Cost</strong>
                    </Typography>
                    <Typography variant="body1">
                      <NumericFormat
                        value={data.CostBreakdown?.costToFix?.cost}
                        displayType="text"
                        thousandSeparator
                        prefix="$"
                        renderText={(value) => (
                          <Typography variant="h5">{value}</Typography>
                        )}
                      />
                    </Typography>
                    <Typography variant="body2" sx={{ marginTop: 1 }}>
                      {data.CostBreakdown?.costToFix?.Reasoning}
                    </Typography>
                  </Box>
                </Grid>

                {/* Hardware Cost Section */}
                <Grid
                  item
                  xs={12}
                  sm={6}
                  sx={{ display: "flex", justifyContent: "center" }}
                >
                  <Box sx={{ textAlign: "center" }}>
                    <MonetizationOnIcon
                      sx={{
                        fontSize: 60,
                        color: "#f57c00", // Orange color for the icon (you can customize)
                      }}
                    />
                    <Typography variant="h6" sx={{ marginTop: 1 }}>
                      <strong>Hardware Cost</strong>
                    </Typography>
                    <Typography variant="body1">
                      <NumericFormat
                        value={data.CostBreakdown?.HardwareCostPerSystem?.cost}
                        displayType="text"
                        thousandSeparator
                        prefix="$"
                        renderText={(value) => (
                          <Typography variant="h5">{value}</Typography>
                        )}
                      />
                    </Typography>
                    <Typography variant="body2" sx={{ marginTop: 1 }}>
                      {data.CostBreakdown?.HardwareCostPerSystem?.Reasoning}
                    </Typography>
                  </Box>
                </Grid>
              </Grid>
            </Box>

            <Divider sx={{ margin: "16px 0" }} />

            {/* Action Plan Section */}
            <Box
              sx={{
                padding: 2,
                backgroundColor: "#f7f7f7",
                borderRadius: 2,
                marginBottom: 2,
              }}
            >
              <Typography variant="h6">Action Plan</Typography>
              <Grid container spacing={2}>
                {data.ActionPlan.map((step, index) => (
                  <Grid item xs={12} md={6} key={index}>
                    <Box sx={{ display: "flex", alignItems: "center" }}>
                      <CheckCircleIcon
                        color="primary"
                        sx={{ marginRight: 1 }}
                      />
                      <Typography>{step}</Typography>
                    </Box>
                  </Grid>
                ))}
              </Grid>
            </Box>

            <Divider sx={{ margin: "16px 0" }} />

            {/* Skills Needed Section with Enhanced Design */}
            <Box
              sx={{ padding: 2, backgroundColor: "#f7f7f7", borderRadius: 2 }}
            >
              <Typography variant="h6" mb={1}>
                Skills Needed
              </Typography>
              <Grid container spacing={1}>
                {data.SkillsNeeded.map((skill, index) => (
                  <Grid item xs={12} sm={6} md={4} key={index}>
                    <Chip
                      label={skill}
                      sx={{
                        backgroundColor: "#388e3c", // Green color for the chip
                        color: "white",
                        padding: "8px 16px",
                        borderRadius: "20px",
                        fontWeight: "bold",
                        boxShadow: 1,
                        transition:
                          "transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease",
                        "&:hover": {
                          backgroundColor: "#2c6b2f", // Darker green on hover
                          transform: "scale(1.1)",
                          boxShadow: "0px 4px 10px rgba(0, 0, 0, 0.15)",
                        },
                      }}
                    />
                  </Grid>
                ))}
              </Grid>
            </Box>
          </CardContent>
        </animated.div>
      </Collapse>
    </Card>
  );
};

export default VulnerabilityCard;
