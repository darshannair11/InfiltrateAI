import React, { useState } from "react";
import {
  Card,
  CardContent,
  CardActions,
  Typography,
  Collapse,
  IconButton,
  Box,
  Divider,
  Grid,
  Chip,
} from "@mui/material";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import InsightsIcon from "@mui/icons-material/Insights";
import { useSpring, animated } from "react-spring";
import { NumericFormat } from "react-number-format";
import MonetizationOnIcon from "@mui/icons-material/MonetizationOn";
import AccessTimeIcon from "@mui/icons-material/AccessTime";
import HourglassEmptyIcon from "@mui/icons-material/HourglassEmpty";
import ScheduleIcon from "@mui/icons-material/Schedule"; // Icon to indicate estimated time

// Helper function to get severity color based on numeric value
const getSeverityColor = (severity) => {
  if (severity >= 8) return "#d32f2f"; // Red for Critical (Severity >= 8)
  if (severity >= 5) return "#f57c00"; // Orange for High (Severity >= 5)
  if (severity >= 3) return "#4caf50"; // Green for Medium (Severity >= 3)
  return "#81c784"; // Lighter Green for Low (Severity < 3)
};

const VulnerabilityCard = ({ vuln, data }) => {
  const [expanded, setExpanded] = useState(false);
  const toggleExpand = () => setExpanded(!expanded);

  const severityColor = getSeverityColor(vuln.Severity); // Get the severity color

  // Spring animation for expand/collapse effect
  const animationProps = useSpring({
    opacity: expanded ? 1 : 0,
    transform: expanded ? "translateY(0)" : "translateY(-10px)",
    scale: expanded ? 1 : 1.05, // Adds a slight zoom in effect when the card is expanded
    boxShadow: expanded
      ? "0px 4px 20px rgba(0, 0, 0, 0.2)"
      : "0px 2px 10px rgba(0, 0, 0, 0.1)", // Adds shadow when expanded for a "highlighted" effect
  });

  // Hover animation for the Insights Icon button
  const hoverProps = useSpring({
    transform: expanded ? "rotate(0deg)" : "rotate(180deg)", // Icon rotates when expanded
    scale: expanded ? 1 : 1.2, // Slight scale change on hover
  });

  return (
    <Card variant="outlined" sx={{ margin: "16px 0", borderColor: "#81c784" }}>
      <CardContent
        sx={{ display: "flex", flexDirection: "row", alignItems: "center" }}
      >
        <Box sx={{ flexGrow: 1 }}>
          <Typography variant="h6">{vuln.CVE}</Typography>
          <Typography>
            <strong>Port:</strong> {vuln.Port}
          </Typography>
          <Typography>
            <strong>Protocol:</strong> {vuln.Protocol}
          </Typography>
        </Box>

        <Box
          sx={{
            display: "inline-block",
            padding: "4px 12px",
            borderRadius: "20px",
            backgroundColor: severityColor,
            color: "white",
            fontWeight: "bold",
            marginLeft: "auto",
            textAlign: "center",
            fontSize: "24px",
          }}
        >
          {vuln.Severity}
        </Box>
      </CardContent>

      <CardActions>
        <IconButton
          onClick={toggleExpand}
          sx={{ transition: "transform 0.3s", marginLeft: "auto" }}
        >
          <animated.div style={hoverProps}>
            <InsightsIcon />
          </animated.div>
        </IconButton>
      </CardActions>

      <Collapse in={expanded} timeout="auto" unmountOnExit>
        <animated.div style={animationProps}>
          <CardContent>
            {/* Cost Breakdown Section with Enhanced UI */}
            <Box
              sx={{ display: "flex", flexDirection: "column", marginBottom: 2 }}
            >
              <Typography variant="h6" sx={{ marginBottom: 2 }}>
                Cost Breakdown
              </Typography>

              {/* Grid Layout for Side-by-Side Cost Display */}
              <Grid container spacing={4}>
                {/* Fix Cost Section */}
                <Grid
                  item
                  xs={12}
                  sm={6}
                  sx={{ display: "flex", justifyContent: "center" }}
                >
                  <Box sx={{ textAlign: "center" }}>
                    <MonetizationOnIcon
                      sx={{
                        fontSize: 60,
                        color: "#388e3c", // Green color for the icon (you can customize)
                      }}
                    />
                    <Typography variant="h6" sx={{ marginTop: 1 }}>
                      <strong>Fix Cost</strong>
                    </Typography>
                    <Typography variant="body1">
                      <NumericFormat
                        value={data.CostBreakdown?.costToFix?.cost}
                        displayType="text"
                        thousandSeparator
                        prefix="$"
                        renderText={(value) => (
                          <Typography variant="h5">{value}</Typography>
                        )}
                      />
                    </Typography>
                    <Typography variant="body2" sx={{ marginTop: 1 }}>
                      {data.CostBreakdown?.costToFix?.Reasoning}
                    </Typography>
                  </Box>
                </Grid>

                {/* Hardware Cost Section */}
                <Grid
                  item
                  xs={12}
                  sm={6}
                  sx={{ display: "flex", justifyContent: "center" }}
                >
                  <Box sx={{ textAlign: "center" }}>
                    <MonetizationOnIcon
                      sx={{
                        fontSize: 60,
                        color: "#4caf50", // Light green color for the icon
                      }}
                    />
                    <Typography variant="h6" sx={{ marginTop: 1 }}>
                      <strong>Hardware Cost</strong>
                    </Typography>
                    <Typography variant="body1">
                      <NumericFormat
                        value={data.CostBreakdown?.HardwareCostPerSystem?.cost}
                        displayType="text"
                        thousandSeparator
                        prefix="$"
                        renderText={(value) => (
                          <Typography variant="h5">{value}</Typography>
                        )}
                      />
                    </Typography>
                    <Typography variant="body2" sx={{ marginTop: 1 }}>
                      {data.CostBreakdown?.HardwareCostPerSystem?.Reasoning}
                    </Typography>
                  </Box>
                </Grid>
              </Grid>
            </Box>

            <Divider sx={{ margin: "16px 0" }} />

            {/* Large, Clear Time Display with Estimated Time Badge */}
            <Box
              sx={{
                display: "flex",
                justifyContent: "center",
                padding: 2,
                backgroundColor: "#e8f5e9", // Light green background
                borderRadius: 2,
                marginBottom: 2,
                alignItems: "center",
              }}
            >
              <AccessTimeIcon
                sx={{ fontSize: 40, color: "#388e3c", marginRight: 1 }}
              />
              <Typography variant="h4" sx={{ fontWeight: "bold" }}>
                {Math.floor(data.TimeToFixPerSystemInMinutes / 60)} hours
                <HourglassEmptyIcon
                  sx={{
                    fontSize: 40,
                    color: "#388e3c",
                    marginLeft: 2,
                    marginRight: 1,
                  }}
                />
                {data.TimeToFixPerSystemInMinutes % 60} minutes
              </Typography>
              <Box
                sx={{
                  display: "flex",
                  alignItems: "center",
                  marginLeft: 2,
                  backgroundColor: "#4caf50", // Light green badge color
                  padding: "4px 12px",
                  borderRadius: "12px",
                  color: "white",
                  fontWeight: "bold",
                  fontSize: "14px",
                }}
              >
                <ScheduleIcon sx={{ marginRight: 1 }} />
                Estimated Time
              </Box>
            </Box>

            <Divider sx={{ margin: "16px 0" }} />

            {/* Interactive Action Plan Timeline */}
            <Box sx={{ marginTop: 3 }}>
              <Typography variant="h6" sx={{ marginBottom: 2 }}>
                Action Plan
              </Typography>
              <Box
                sx={{
                  display: "flex",
                  flexDirection: "column",
                  paddingLeft: 2,
                  borderLeft: "3px solid #4caf50",
                }}
              >
                {data.ActionPlan.map((step, index) => (
                  <Box
                    key={index}
                    sx={{
                      display: "flex",
                      alignItems: "center",
                      marginBottom: 2,
                    }}
                  >
                    <Box
                      sx={{
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        width: 40,
                        height: 40,
                        borderRadius: "50%",
                        backgroundColor: "#388e3c",
                        color: "white",
                        fontWeight: "bold",
                        marginRight: 2,
                      }}
                    >
                      {index + 1}
                    </Box>
                    <Box sx={{ flexGrow: 1 }}>
                      <Typography variant="body1" sx={{ fontWeight: "bold" }}>
                        {step}
                      </Typography>
                      <Typography variant="body2">
                        Estimated time:{" "}
                        {data.ActionPlanTimes?.[index]
                          ? data.ActionPlanTimes[index]
                          : "N/A"}
                      </Typography>
                    </Box>
                  </Box>
                ))}
              </Box>
            </Box>

            <Divider sx={{ margin: "16px 0" }} />

            {/* Skills Needed Section with Enhanced Design */}
            <Box
              sx={{
                padding: 2,
                backgroundColor: "#e8f5e9", // Light green background
                borderRadius: 2,
              }}
            >
              <Typography variant="h6" mb={1}>
                Skills Needed
              </Typography>
              <Grid container spacing={1}>
                {data.SkillsNeeded.map((skill, index) => (
                  <Grid item xs={12} md={6} key={index}>
                    <Chip
                      label={skill}
                      sx={{
                        backgroundColor: "#81c784", // Light green color for skills
                        color: "#ffffff",
                      }}
                    />
                  </Grid>
                ))}
              </Grid>
            </Box>
          </CardContent>
        </animated.div>
      </Collapse>
    </Card>
  );
};

export default VulnerabilityCard;
